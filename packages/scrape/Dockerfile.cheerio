FROM node:20-bookworm-slim AS base

LABEL org.opencontainers.image.source=https://github.com/any4ai/AnyCrawl
LABEL org.opencontainers.image.description="AnyCrawl Scrape Cheerio Worker"
LABEL org.opencontainers.image.licenses=MIT

ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
ENV NODE_ENV=production

# üîë procps provides `ps` (fixes spawn ps ENOENT)
RUN corepack enable pnpm && \
    apt-get update && apt-get install -y \
      build-essential \
      python3 \
      make \
      g++ \
      procps \
    && rm -rf /var/lib/apt/lists/*

FROM base AS build
WORKDIR /usr/src/app

COPY package.json pnpm-lock.yaml pnpm-workspace.yaml turbo.json ./
COPY packages/libs/package.json ./packages/libs/package.json
COPY packages/scrape/package.json ./packages/scrape/package.json
COPY packages/db/package.json ./packages/db/package.json
COPY packages/ai/package.json ./packages/ai/package.json
COPY packages/template-client/package.json ./packages/template-client/package.json
COPY packages/typescript-config/package.json ./packages/typescript-config/package.json

RUN --mount=type=cache,id=pnpm-glibc,target=/pnpm/store \
    pnpm install --frozen-lockfile --prod=false

COPY . .

RUN pnpm build \
    --filter=@anycrawl/libs \
    --filter=@anycrawl/db \
    --filter=@anycrawl/template-client \
    --filter=@anycrawl/ai \
    --filter=@anycrawl/scrape

RUN rm -rf node_modules

FROM base AS scrape-cheerio
WORKDIR /usr/src/app/packages/scrape

COPY --from=build /usr/src/app/pnpm-lock.yaml /usr/src/app/pnpm-lock.yaml
COPY --from=build /usr/src/app/pnpm-workspace.yaml /usr/src/app/pnpm-workspace.yaml

COPY --from=build /usr/src/app/packages/eslint-config/package.json /usr/src/app/packages/eslint-config/package.json
COPY --from=build /usr/src/app/packages/search/package.json /usr/src/app/packages/search/package.json
COPY --from=build /usr/src/app/packages/typescript-config/package.json /usr/src/app/packages/typescript-config/package.json
COPY --from=build /usr/src/app/packages/template-client/package.json /usr/src/app/packages/template-client/package.json

COPY --from=build /usr/src/app/packages/scrape/dist /usr/src/app/packages/scrape/dist
COPY --from=build /usr/src/app/packages/libs/dist /usr/src/app/packages/libs/dist
COPY --from=build /usr/src/app/packages/db/dist /usr/src/app/packages/db/dist
COPY --from=build /usr/src/app/packages/ai/dist /usr/src/app/packages/ai/dist
COPY --from=build /usr/src/app/packages/template-client/dist /usr/src/app/packages/template-client/dist

COPY --from=build /usr/src/app/packages/scrape/package.json /usr/src/app/packages/scrape/package.json
COPY --from=build /usr/src/app/packages/libs/package.json /usr/src/app/packages/libs/package.json
COPY --from=build /usr/src/app/packages/db/package.json /usr/src/app/packages/db/package.json
COPY --from=build /usr/src/app/packages/ai/package.json /usr/src/app/packages/ai/package.json
COPY --from=build /usr/src/app/packages/template-client/package.json /usr/src/app/packages/template-client/package.json

RUN --mount=type=cache,id=pnpm-glibc,target=/pnpm/store \
    pnpm install --prod --frozen-lockfile

# üîê rebuild native sqlite for glibc
RUN pnpm rebuild better-sqlite3

ENV ANYCRAWL_AVAILABLE_ENGINES=cheerio

CMD ["node", "dist/Worker.js"]
